import { NextApiRequest, NextApiResponse } from 'next';
import realTimeSync from '../../lib/realTimeSync';
import { mockSmartAutoPilot } from '../../lib/mockData';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method === 'GET') {
    try {
      const stats = realTimeSync.getSmartSyncStats();
      
      res.status(200).json({
        success: true,
        message: 'Smart Auto-Pilot status retrieved successfully',
        data: {
          ...stats,
          status: stats.smartSyncEnabled ? 'üß† SMART AUTO-PILOT ACTIVE' : 'üìä STANDARD AUTO-PILOT',
          description: stats.smartSyncEnabled 
            ? '‡∏£‡∏∞‡∏ö‡∏ö Smart Auto-Pilot ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û ‡πÉ‡∏ä‡πâ Smart Delta Sync ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î 70-80% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£'
            : '‡∏£‡∏∞‡∏ö‡∏ö Standard Auto-Pilot ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
        }
      });
    } catch (error) {
      console.error('Error getting smart auto pilot status, using mock data:', error);
      res.status(200).json({
        success: true,
        message: 'Using mock data for Smart Auto-Pilot',
        data: mockSmartAutoPilot
      });
    }
  } else if (req.method === 'POST') {
    try {
      const { action } = req.body;

      if (action === 'enable') {
        realTimeSync.enableSmartSync();
        res.status(200).json({
          success: true,
          message: 'üöÄ Smart Auto-Pilot ENABLED! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
          data: {
            smartSyncEnabled: true,
            status: 'üß† SMART AUTO-PILOT ACTIVE',
            description: 'Smart Delta Sync ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ - ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£ 70-80%',
            effect: '‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£ 70-80%, ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á',
            autoMode: 'Smart Delta Sync ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ'
          }
        });
      } else if (action === 'disable') {
        realTimeSync.disableSmartSync();
        res.status(200).json({
          success: true,
          message: 'üìä Switched to Standard Auto-Pilot - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
          data: {
            smartSyncEnabled: false,
            status: 'üìä STANDARD AUTO-PILOT',
            description: 'Standard incremental sync ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
            effect: '‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
            autoMode: 'Standard incremental sync ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ'
          }
        });
      } else if (action === 'restart') {
        // Restart ‡∏£‡∏∞‡∏ö‡∏ö real-time sync
        console.log('Restarting Smart Auto-Pilot system...');
        await realTimeSync.initialize();
        res.status(200).json({
          success: true,
          message: 'üîÑ Smart Auto-Pilot system restarted successfully!',
          data: realTimeSync.getSmartSyncStats()
        });
      } else {
        res.status(400).json({
          success: false,
          error: 'Invalid action. Use "enable", "disable", or "restart"'
        });
      }
    } catch (error) {
      console.error('Error handling smart auto pilot action:', error);
      res.status(500).json({
        success: false,
        error: 'Internal server error'
      });
    }
  } else {
    res.status(405).json({
      success: false,
      error: 'Method not allowed'
    });
  }
}
