// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
require('dotenv').config({ path: '.env.local' });
const { google } = require('googleapis');

// ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Sheet ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
const YOUR_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1YoK5BDXh3J8qnuvaPhJvdst7v4Xatn6DywiQ7SepPVI/edit';

function extractSheetId(url) {
  const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  return match ? match[1] : null;
}

async function testYourSheet() {
  const sheetId = extractSheetId(YOUR_SHEET_URL);
  
  if (!sheetId) {
    console.log('‚ùå URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    return;
  }

  console.log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...');
  console.log('üîó URL:', YOUR_SHEET_URL);
  console.log('üÜî Sheet ID:', sheetId);

  try {
    const auth = new google.auth.GoogleAuth({
      keyFile: './credentials.json',
      scopes: ['https://www.googleapis.com/auth/spreadsheets.readonly'],
    });

    const sheets = google.sheets({ version: 'v4', auth });

    // ‡∏î‡∏∂‡∏á metadata
    const spreadsheet = await sheets.spreadsheets.get({
      spreadsheetId: sheetId,
    });

    console.log('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    console.log('üìã ‡∏ä‡∏∑‡πà‡∏≠ Sheet:', spreadsheet.data.properties?.title);
    
    const sheetNames = spreadsheet.data.sheets?.map(sheet => 
      sheet.properties?.title
    ) || [];
    
    console.log('üìÑ Tabs ‡∏ó‡∏µ‡πà‡∏°‡∏µ:', sheetNames);

    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å tab ‡πÅ‡∏£‡∏Å
    if (sheetNames.length > 0) {
      const firstSheet = sheetNames[0];
      console.log('\nüìä ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å tab:', firstSheet);
      
      const values = await sheets.spreadsheets.values.get({
        spreadsheetId: sheetId,
        range: `${firstSheet}!A1:Z20`,
      });

      const rows = values.data.values || [];
      console.log('üìà ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß:', rows.length);
      
      if (rows.length > 0) {
        console.log('üè∑Ô∏è  Column Headers:', rows[0]);
        
        if (rows.length > 1) {
          console.log('üìù ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2:', rows[1]);
        }
        
        if (rows.length > 2) {
          console.log('üìù ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 3:', rows[2]);
        }

        console.log('\nüéâ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!');
        console.log('üìù ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ URL ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
        console.log('üîó', YOUR_SHEET_URL);
      }
    }

  } catch (error) {
    console.log('\n‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error.message);
    
    if (error.code === 403) {
      console.log('üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:');
      console.log('1. ‡πÄ‡∏õ‡∏¥‡∏î Google Sheet ‡∏ô‡∏µ‡πâ:', YOUR_SHEET_URL);
      console.log('2. ‡∏Ñ‡∏•‡∏¥‡∏Ñ Share');
      console.log('3. ‡πÄ‡∏û‡∏¥‡πà‡∏° email: newgate@possible-point-428513-k6.iam.gserviceaccount.com');
      console.log('4. ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Viewer');
      console.log('5. ‡∏Ñ‡∏•‡∏¥‡∏Å Send');
    }
  }
}

testYourSheet();