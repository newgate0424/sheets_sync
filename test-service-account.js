// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Service Account
require('dotenv').config({ path: '.env.local' });
const { google } = require('googleapis');
const fs = require('fs');

async function testServiceAccount() {
  console.log('üîë ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Service Account...\n');

  try {
    // ‡∏≠‡πà‡∏≤‡∏ô credentials.json
    const credentialsPath = './credentials.json';
    
    if (!fs.existsSync(credentialsPath)) {
      console.log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå credentials.json');
      return;
    }

    const credentials = JSON.parse(fs.readFileSync(credentialsPath, 'utf8'));
    console.log('‚úÖ ‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå credentials.json');
    console.log('üìß Service Account Email:', credentials.client_email);
    console.log('üÜî Project ID:', credentials.project_id);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á auth
    const auth = new google.auth.GoogleAuth({
      keyFile: credentialsPath,
      scopes: ['https://www.googleapis.com/auth/spreadsheets.readonly'],
    });

    const sheets = google.sheets({ version: 'v4', auth });
    console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Google Sheets client ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö sheet ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ service account
    console.log('\nüìù ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤:');
    console.log('1. ‡πÄ‡∏õ‡∏¥‡∏î Google Sheets ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ');
    console.log('2. ‡∏Ñ‡∏•‡∏¥‡∏Å Share');
    console.log('3. ‡πÄ‡∏û‡∏¥‡πà‡∏° email ‡∏ô‡∏µ‡πâ:', credentials.client_email);
    console.log('4. ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Viewer');
    console.log('5. ‡∏Å‡∏î Send');

    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ sheet ID ‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö
    const TEST_SHEET_ID = '1YoK5BDXh3J8qnuvaPhJvdst7v4Xatn6DywiQ7SepPVI'; // ‡πÅ‡∏ó‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Sheet ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    
    if (TEST_SHEET_ID) {
      console.log('\nüß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Sheet...');
      console.log('üìä Sheet ID:', TEST_SHEET_ID);

      try {
        // ‡∏î‡∏∂‡∏á metadata
        const spreadsheet = await sheets.spreadsheets.get({
          spreadsheetId: TEST_SHEET_ID,
        });

        console.log('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        console.log('üìã Sheet Title:', spreadsheet.data.properties?.title);
        
        const sheetNames = spreadsheet.data.sheets?.map(sheet => 
          sheet.properties?.title
        ) || [];
        console.log('üìÑ Sheet tabs:', sheetNames.join(', '));

        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        if (sheetNames.length > 0) {
          const firstSheet = sheetNames[0];
          const values = await sheets.spreadsheets.values.get({
            spreadsheetId: TEST_SHEET_ID,
            range: `${firstSheet}!A1:Z10`,
          });

          const rows = values.data.values || [];
          console.log('üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏ö:', rows.length, '‡πÅ‡∏ñ‡∏ß');
          
          if (rows.length > 0) {
            console.log('üè∑Ô∏è  Headers:', rows[0]);
            if (rows.length > 1) {
              console.log('üìù ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', rows[1]);
            }
          }

          console.log('\nüéâ Service Account ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!');
        }

      } catch (error) {
        if (error.code === 403) {
          console.log('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Sheet');
          console.log('üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ä‡∏£‡πå Google Sheet ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö:', credentials.client_email);
        } else if (error.code === 404) {
          console.log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet ‡∏´‡∏£‡∏∑‡∏≠ Sheet ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        } else {
          console.log('‚ùå Error:', error.message);
        }
      }
    }

  } catch (error) {
    console.log('‚ùå Error:', error.message);
  }
}

testServiceAccount();