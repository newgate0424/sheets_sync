// debug-sync.js - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ sync ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
require('dotenv').config({ path: '.env.local' });
const mysql = require('mysql2/promise');
const { google } = require('googleapis');
const fs = require('fs');

async function debugSync() {
  let connection;
  try {
    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ database
    connection = await mysql.createConnection({
      host: process.env.DB_HOST || 'localhost',
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || '',
      database: process.env.DB_NAME || 'sheets_sync'
    });

    console.log('=== DATABASE SYNC DEBUG ===\n');
    console.log(`üì° Connected to: ${process.env.DB_HOST}/${process.env.DB_NAME}\n`);

    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ sync configs
    const [configs] = await connection.execute(`
      SELECT id, name, table_name, sheet_url, sheet_name, columns, row_count, last_sync_at
      FROM sync_configs 
      WHERE is_active = 1
    `);

    if (configs.length === 0) {
      console.log('‡πÑ‡∏°‡πà‡∏û‡∏ö sync configuration ‡∏ó‡∏µ‡πà active');
      return;
    }

    for (const config of configs) {
      console.log(`\nüìã Config: ${config.name}`);
      console.log(`üìä Table: ${config.table_name}`);
      console.log(`üîó Sheet: ${config.sheet_name}`);
      console.log(`üìà Recorded Row Count: ${config.row_count || 'N/A'}`);
      console.log(`üïí Last Sync: ${config.last_sync_at || 'Never'}`);

      // ‡∏ô‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô database
      const [dbCount] = await connection.execute(`
        SELECT COUNT(*) as count FROM \`${config.table_name}\`
      `);
      const actualDbCount = dbCount[0].count;
      
      console.log(`üíæ Actual DB Rows: ${actualDbCount}`);

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ tracking columns
      const [untracked] = await connection.execute(`
        SELECT COUNT(*) as count FROM \`${config.table_name}\`
        WHERE sheet_row_index IS NULL OR row_hash IS NULL
      `);
      const untrackedCount = untracked[0].count;
      
      if (untrackedCount > 0) {
        console.log(`‚ö†Ô∏è  Untracked Rows: ${untrackedCount} (rows without sheet_row_index or row_hash)`);
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ tracking
        const [sampleUntracked] = await connection.execute(`
          SELECT id, sheet_row_index, row_hash FROM \`${config.table_name}\`
          WHERE sheet_row_index IS NULL OR row_hash IS NULL
          LIMIT 5
        `);
        
        console.log('üìÑ Sample untracked rows:');
        sampleUntracked.forEach(row => {
          console.log(`   ID: ${row.id}, sheet_row_index: ${row.sheet_row_index}, row_hash: ${row.row_hash}`);
        });
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheets
      try {
        const auth = new google.auth.GoogleAuth({
          keyFile: './credentials.json',
          scopes: ['https://www.googleapis.com/auth/spreadsheets.readonly']
        });

        const sheets = google.sheets({ version: 'v4', auth });
        const spreadsheetId = extractSpreadsheetId(config.sheet_url);
        
        const response = await sheets.spreadsheets.values.get({
          spreadsheetId: spreadsheetId,
          range: config.sheet_name,
        });

        const sheetData = response.data.values || [];
        const sheetRowCount = Math.max(0, sheetData.length - 1); // ‡∏•‡∏ö header row
        
        console.log(`üìÑ Google Sheets Rows: ${sheetRowCount} (excluding header)`);
        
        if (actualDbCount !== sheetRowCount) {
          console.log(`‚ùå MISMATCH! Database has ${actualDbCount} rows but Google Sheets has ${sheetRowCount} rows`);
          console.log(`üìä Difference: ${actualDbCount - sheetRowCount} rows`);
          
          if (actualDbCount > sheetRowCount) {
            console.log('üí° Database has MORE data than Google Sheets - might be duplicate sync issue');
          } else {
            console.log('üí° Google Sheets has MORE data than Database - sync might be incomplete');
          }
        } else {
          console.log('‚úÖ Row counts match!');
        }

      } catch (sheetError) {
        console.log(`‚ùå Cannot access Google Sheets: ${sheetError.message}`);
      }

      // ‡∏î‡∏π sync logs ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      const [logs] = await connection.execute(`
        SELECT status, message, rows_synced, created_at
        FROM sync_logs 
        WHERE config_id = ?
        ORDER BY created_at DESC
        LIMIT 5
      `, [config.id]);

      if (logs.length > 0) {
        console.log('\nüìä Recent Sync Logs:');
        logs.forEach((log, i) => {
          console.log(`   ${i + 1}. [${log.status}] ${log.message} (${log.rows_synced} rows) - ${log.created_at}`);
        });
      }

      console.log('\n' + '='.repeat(80));
    }

  } catch (error) {
    console.error('Error:', error);
  } finally {
    if (connection) {
      await connection.end();
    }
  }
}

function extractSpreadsheetId(url) {
  const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  return match ? match[1] : null;
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ
debugSync().catch(console.error);
